<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <title>Garage</title>
</head>
<body>
<h1>Garage</h1>
<a href="/">‚Üê Back to Home</a>

<h2>Cars</h2>
<ul id="carList"></ul>

<h2>Add / Edit Car</h2>
<form id="carForm">
    <input id="carId" type="hidden"/>
    <label for="name">Name:</label>
    <input id="name" required type="text"/><br/>

    <label for="fuelType">Fuel Type:</label>
    <select id="fuelType" required></select><br/>

    <label for="engineCapacity">Engine Capacity (cc):</label>
    <input id="engineCapacity" min="0" required type="number"/><br/>

    <button type="submit">Save</button>
</form>

<div id="message"></div>

<script>
    const token = localStorage.getItem("token");

    if (!token) {
        document.getElementById("message").textContent = "Not authenticated.";
    }

    const carList = document.getElementById("carList");
    const carForm = document.getElementById("carForm");
    const carIdField = document.getElementById("carId");
    const nameField = document.getElementById("name");
    const fuelTypeField = document.getElementById("fuelType");
    const engineCapacityField = document.getElementById("engineCapacity");
    const messageDiv = document.getElementById("message");

    function loadFuelTypes() {
        fetch("/api/enums/fuel-types")
            .then(response => response.json())
            .then(data => {
                fuelTypeField.innerHTML = "";
                data.forEach(type => {
                    const option = document.createElement("option");
                    option.value = type;
                    option.textContent = type;
                    fuelTypeField.appendChild(option);
                });
            });
    }

    function loadCars() {
        fetch("/api/cars", {
            headers: {
                "Authorization": "Bearer " + token
            }
        })
            .then(response => {
                if (!response.ok) throw new Error("Unauthorized");
                return response.json();
            })
            .then(data => {
                const cars = Array.isArray(data) ? data : data.content || [];
                carList.innerHTML = "";

                if (cars.length === 0) {
                    const li = document.createElement("li");
                    li.textContent = "No cars available.";
                    carList.appendChild(li);
                } else {
                    cars.forEach(car => {
                        const li = document.createElement("li");
                        li.innerHTML = `${car.name} (${car.fuelType}, ${car.engineCapacity}cc)
                <button onclick="editCar('${car.id}')">Edit</button>
                <button onclick="deleteCar('${car.id}')">Delete</button>`;
                        carList.appendChild(li);
                    });
                }
            })
            .catch(err => {
                messageDiv.textContent = err.message;
            });
    }

    carForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const car = {
            name: nameField.value,
            fuelType: fuelTypeField.value,
            engineCapacity: parseInt(engineCapacityField.value)
        };

        const method = carIdField.value ? "PUT" : "POST";
        const url = carIdField.value ? `/api/cars/${carIdField.value}` : "/api/cars";

        fetch(url, {
            method: method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify(car)
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to save car");
                return res.json();
            })
            .then(() => {
                messageDiv.textContent = "Car saved successfully.";
                carForm.reset();
                carIdField.value = "";
                loadCars();
            })
            .catch(err => {
                messageDiv.textContent = err.message;
            });
    });

    window.editCar = function (id) {
        fetch(`/api/cars/${id}`, {
            headers: {
                "Authorization": "Bearer " + token
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to load car");
                return res.json();
            })
            .then(car => {
                carIdField.value = car.id;
                nameField.value = car.name;
                fuelTypeField.value = car.fuelType;
                engineCapacityField.value = car.engineCapacity;
            });
    };

    window.deleteCar = function (id) {
        if (!confirm("Are you sure you want to delete this car?")) return;

        fetch(`/api/cars/${id}`, {
            method: "DELETE",
            headers: {
                "Authorization": "Bearer " + token
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to delete car");
                loadCars();
                messageDiv.textContent = "Car deleted.";
            })
            .catch(err => {
                messageDiv.textContent = err.message;
            });
    };

    loadFuelTypes();
    loadCars();
</script>

</body>
</html>
