<!DOCTYPE html>
<html layout:decorate="~{base}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
<head>
    <title layout:fragment="title">Home Page</title>
</head>
<body>
<main layout:fragment="content">
    <ul class="list-group mb-4">
        <li class="list-group-item" id="loginLink"><a href="/login">Login Page</a></li>
        <li class="list-group-item" id="meLink" style="display: none;"><a href="/me">User Info</a></li>
        <li class="list-group-item" id="adminLink" style="display: none;"><a href="/admin">Admin Panel</a></li>
        <li class="list-group-item"><a href="/garage">Garage</a></li>
        <li class="list-group-item"><a href="/trips">Trips</a></li>
        <li class="list-group-item"><a href="/swagger-ui/index.html" target="_blank">Swagger UI</a></li>
    </ul>

    <div class="text-center mb-3" id="authActions"></div>

    <script>
        const token = localStorage.getItem("token");

        if (token) {
            document.getElementById("meLink").style.display = "list-item";
            const loginLink = document.getElementById("loginLink");
            if (loginLink) loginLink.style.display = "none";

            const authActions = document.getElementById("authActions");
            if (authActions) {
                const logoutBtn = document.createElement("button");
                logoutBtn.textContent = "Logout";
                logoutBtn.className = "btn btn-danger";
                logoutBtn.onclick = function () {
                    localStorage.removeItem("token");
                    window.location.href = "/";
                };
                authActions.appendChild(logoutBtn);
            }

            fetch("/api/me", {
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
                .then(response => {
                    if (!response.ok) {
                        console.warn("Token seems invalid or expired.");
                        localStorage.removeItem("token");
                        return null;
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    const roles = data.roles || [];
                    if (roles.includes("ADMIN")) {
                        document.getElementById("adminLink").style.display = "list-item";
                    }
                })
                .catch(err => {
                    console.error("Error fetching user info:", err);
                    localStorage.removeItem("token");
                });
        }
    </script>
</main>
</body>
</html>
