<!DOCTYPE html>
<html th:replace="~{base :: layout (~{::title}, ~{::section})}"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Admin Panel</title>
</head>

<section>
    <h1 class="mb-4">Admin Panel</h1>

    <!-- Reset Password -->
    <div class="card mb-4">
        <div class="card-header">Reset User Password</div>
        <div class="card-body">
            <form id="resetPasswordForm">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input class="form-control" id="resetUsername" required type="text">
                </div>
                <div class="mb-3">
                    <label class="form-label">New Password</label>
                    <input class="form-control" id="resetNewPassword" required type="password">
                </div>
                <button class="btn btn-warning" type="submit">Reset Password</button>
            </form>
            <div class="mt-2 text-success" id="resetPasswordMessage"></div>
        </div>
    </div>

    <!-- Manage Roles -->
    <div class="card mb-4">
        <div class="card-header">Manage User Roles</div>
        <div class="card-body">
            <form class="mb-3" id="addRoleForm">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input class="form-control" id="addRoleUsername" required type="text">
                </div>
                <div class="mb-3">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="addRole">
                        <option value="USER">USER</option>
                        <option value="WORKER">WORKER</option>
                        <option value="ADMIN">ADMIN</option>
                    </select>
                </div>
                <button class="btn btn-primary" type="submit">Add Role</button>
            </form>

            <form id="setRolesForm">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input class="form-control" id="setRolesUsername" required type="text">
                </div>
                <div class="mb-3">
                    <label class="form-label">Roles (comma separated)</label>
                    <input class="form-control" id="setRoles" placeholder="e.g. USER,ADMIN" type="text">
                </div>
                <button class="btn btn-secondary" type="submit">Set Roles</button>
            </form>

            <div class="mt-2 text-success" id="roleMessage"></div>
        </div>
    </div>

    <!-- Delete User -->
    <div class="card mb-4">
        <div class="card-header">Delete User</div>
        <div class="card-body">
            <form id="deleteUserForm">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input class="form-control" id="deleteUsername" required type="text">
                </div>
                <button class="btn btn-danger" type="submit">Delete User</button>
            </form>
            <div class="mt-2 text-success" id="deleteMessage"></div>
        </div>
    </div>

    <!-- Actuator Info -->
    <div class="card mb-4">
        <div class="card-header">System Info</div>
        <div class="card-body">
            <button class="btn btn-info mb-2" id="loadInfoBtn">Load Actuator Info</button>
            <pre class="bg-light p-3 border rounded" id="infoResult"></pre>
        </div>
    </div>
</section>

<script>
    const token = localStorage.getItem("token");
    if (!token) {
        alert("You must be logged in as admin to access this page.");
        window.location.href = "/login";
    }

    function apiFetch(url, options = {}) {
        return fetch(url, {
            ...options,
            headers: {
                ...(options.headers || {}),
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            }
        });
    }

    document.getElementById("resetPasswordForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const username = document.getElementById("resetUsername").value;
        const newPassword = document.getElementById("resetNewPassword").value;

        apiFetch(`/api/admin/users/${username}/password`, {
            method: "PATCH",
            body: JSON.stringify({newPassword})
        })
            .then(res => res.json())
            .then(data => document.getElementById("resetPasswordMessage").textContent = data.message)
            .catch(() => document.getElementById("resetPasswordMessage").textContent = "Error resetting password.");
    });

    document.getElementById("addRoleForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const username = document.getElementById("addRoleUsername").value;
        const role = document.getElementById("addRole").value;

        apiFetch(`/api/admin/users/${username}/roles`, {
            method: "PATCH",
            body: JSON.stringify({role})
        })
            .then(res => res.json())
            .then(data => document.getElementById("roleMessage").textContent = data.message)
            .catch(() => document.getElementById("roleMessage").textContent = "Error adding role.");
    });

    document.getElementById("setRolesForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const username = document.getElementById("setRolesUsername").value;
        const rolesStr = document.getElementById("setRoles").value;
        const roles = rolesStr.split(",").map(r => r.trim());

        apiFetch(`/api/admin/users/${username}/roles`, {
            method: "PUT",
            body: JSON.stringify({roles})
        })
            .then(res => res.json())
            .then(data => document.getElementById("roleMessage").textContent = data.message)
            .catch(() => document.getElementById("roleMessage").textContent = "Error setting roles.");
    });

    document.getElementById("deleteUserForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const username = document.getElementById("deleteUsername").value;

        apiFetch(`/api/admin/users/${username}`, {
            method: "DELETE"
        })
            .then(res => {
                if (!res.ok) throw new Error("Delete failed");
                return res.text();
            })
            .then(msg => document.getElementById("deleteMessage").textContent = msg)
            .catch(() => document.getElementById("deleteMessage").textContent = "Error deleting user.");
    });

    document.getElementById("loadInfoBtn").addEventListener("click", () => {
        fetch("/actuator/info")
            .then(res => res.json())
            .then(data => document.getElementById("infoResult").textContent = JSON.stringify(data, null, 2))
            .catch(() => document.getElementById("infoResult").textContent = "Failed to load info.");
    });
</script>
