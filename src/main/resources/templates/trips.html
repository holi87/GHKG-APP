<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trips</title>
</head>
<body>
<h1>Trips</h1>
<a href="/">‚Üê Back to Home</a>

<div id="tripList"></div>

<div id="tripFormContainer" style="display: none;">
    <h2 id="formTitle">Add Trip</h2>
    <form id="tripForm">
        <input id="tripId" type="hidden">
        <label>Name: <input id="tripName" required type="text"></label><br/>
        <label>Type:
            <select id="tripType" required>
                <option value="">-- Select --</option>
            </select>
        </label><br/>
        <label>Start Location: <input id="tripStart" required type="text"></label><br/>
        <label>Destination: <input id="tripEnd" required type="text"></label><br/>
        <label>Distance (km): <input id="tripDistance" min="0" required type="number"></label><br/>
        <label>Duration (e.g. PT2H30M): <input id="tripDuration" required type="text"></label><br/>
        <label>Rating (0-10): <input id="tripRating" max="10" min="0" required type="number"></label><br/>
        <button id="saveTripBtn" type="submit">Save Trip</button>
        <button onclick="hideForm()" type="button">Cancel</button>
    </form>
</div>

<div id="addTripSection" style="display: none;">
    <button onclick="showForm()">Add New Trip</button>
</div>

<script>
    const token = localStorage.getItem("token");
    let userRoles = [];

    function fetchTrips() {
        fetch("/api/trips", {
            headers: {
                "Authorization": "Bearer " + token
            }
        })
            .then(res => res.json())
            .then(trips => {
                const tripList = document.getElementById("tripList");
                tripList.innerHTML = "<ul>" + trips.map(trip => `
                    <li>
                        <strong>${trip.name}</strong> (${trip.type})<br/>
                        From ${trip.startLocation} to ${trip.destination}, ${trip.distance} km, ${trip.duration}, Rating: ${trip.rating}
                        ${userRoles.includes("WORKER") || userRoles.includes("ADMIN") ? `<button onclick="editTrip(${trip.id})">Edit</button>` : ""}
                        ${userRoles.includes("ADMIN") ? `<button onclick="deleteTrip(${trip.id})">Delete</button>` : ""}
                    </li>
                `).join("") + "</ul>";
            });
    }

    function showForm(trip = null) {
        document.getElementById("tripFormContainer").style.display = "block";
        document.getElementById("formTitle").textContent = trip ? "Edit Trip" : "Add Trip";
        if (trip) {
            document.getElementById("tripId").value = trip.id;
            document.getElementById("tripName").value = trip.name;
            document.getElementById("tripType").value = trip.type;
            document.getElementById("tripStart").value = trip.startLocation;
            document.getElementById("tripEnd").value = trip.destination;
            document.getElementById("tripDistance").value = trip.distance;
            document.getElementById("tripDuration").value = trip.duration;
            document.getElementById("tripRating").value = trip.rating;
        } else {
            document.getElementById("tripForm").reset();
            document.getElementById("tripId").value = "";
        }
    }

    function hideForm() {
        document.getElementById("tripFormContainer").style.display = "none";
        document.getElementById("tripForm").reset();
    }

    function editTrip(id) {
        fetch(`/api/trips/${id}`, {
            headers: {
                "Authorization": "Bearer " + token
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("Unauthorized");
                return res.json();
            })
            .then(trip => {
                showForm(trip);
            });
    }

    function deleteTrip(id) {
        if (!confirm("Are you sure you want to delete this trip?")) return;
        fetch(`/api/trips/${id}`, {
            method: "DELETE",
            headers: {
                "Authorization": "Bearer " + token
            }
        }).then(() => fetchTrips());
    }

    document.getElementById("tripForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const id = document.getElementById("tripId").value;
        const method = id ? "PUT" : "POST";
        const url = id ? `/api/trips/${id}` : "/api/trips";

        const trip = {
            name: document.getElementById("tripName").value,
            type: document.getElementById("tripType").value,
            startLocation: document.getElementById("tripStart").value,
            destination: document.getElementById("tripEnd").value,
            distance: parseFloat(document.getElementById("tripDistance").value),
            duration: document.getElementById("tripDuration").value,
            rating: parseInt(document.getElementById("tripRating").value)
        };

        fetch(url, {
            method: method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify(trip)
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to save trip");
                return res.json();
            })
            .then(() => {
                hideForm();
                fetchTrips();
            })
            .catch(err => alert(err.message));
    });

    function checkRoleAndInit() {
        if (!token) return;

        fetch("/api/me", {
            headers: {
                "Authorization": "Bearer " + token
            }
        })
            .then(res => res.ok ? res.json() : Promise.reject())
            .then(user => {
                userRoles = user.roles;
                if (userRoles.includes("WORKER") || userRoles.includes("ADMIN")) {
                    document.getElementById("addTripSection").style.display = "block";
                }
                loadTripTypes();  // <--- TU
                fetchTrips();
            })
            .catch(() => {
                document.getElementById("tripList").textContent = "Unauthorized.";
            });
    }

    function loadTripTypes() {
        fetch("/api/enums/trip-types")
            .then(res => res.json())
            .then(types => {
                const select = document.getElementById("tripType");
                types.forEach(type => {
                    const option = document.createElement("option");
                    option.value = type;
                    option.textContent = type.charAt(0) + type.slice(1).toLowerCase(); // np. Car
                    select.appendChild(option);
                });
            });
    }

    checkRoleAndInit();
</script>

</body>
</html>
